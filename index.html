<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Invader Rooms (RTDB) - Solo Only + Host Lock + Wave Banner + Balance Update</title>
  <style>
    :root { color-scheme: dark; }
    html, body { height: 100%; margin: 0; background:#05070b; color:#e8eefc; font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; overflow:hidden; }
    #app { display:grid; grid-template-rows:auto 1fr; height:100%; }
    header {
      padding:10px 12px; display:flex; gap:12px; align-items:center;
      border-bottom:1px solid rgba(31,42,58,.85);
      background: linear-gradient(180deg, rgba(10,14,22,.85), rgba(10,14,22,.60));
      backdrop-filter: blur(8px);
    }
    header b { font-weight: 900; letter-spacing:.4px; }
    small.mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; color:#a8b3c7; }
    .tag { padding:2px 8px; border-radius: 999px; border:1px solid rgba(31,42,58,.85); background: rgba(11,18,32,.65); color:#a8b3c7; font-size:12px; }
    #statusLine { margin-left:auto; color:#a8b3c7; }
    button { background:#2b69ff; color:white; border:0; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:800; }
    button.secondary { background:#223047; }
    button.danger { background:#b42318; }
    button.ghost { background:transparent; border:1px solid rgba(31,42,58,.85); color:#a8b3c7; }
    button.small { padding:6px 10px; border-radius:10px; font-weight:700; font-size:12px; }
    button[disabled] { opacity:.45; cursor:not-allowed; }
    input { width: 100%; box-sizing:border-box; padding:12px 12px; border-radius:12px; border:1px solid rgba(38,52,74,.9); background: rgba(11,18,32,.85); color:#e8eefc; font-size:16px; }
    .muted { color:#a8b3c7; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .col { display:flex; flex-direction:column; gap:12px; }
    .card {
      border:1px solid rgba(31,42,58,.85);
      border-radius:16px;
      padding:14px;
      background: rgba(14,20,32,.55);
      backdrop-filter: blur(8px);
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .screen { display:none; height:100%; }
    .screen.active { display:block; }
    #bg {
      position: fixed; inset: 0; z-index: -2;
      background:
        radial-gradient(circle at 10% 20%, rgba(255,255,255,.10), transparent 45%),
        radial-gradient(circle at 70% 30%, rgba(255,255,255,.08), transparent 45%),
        radial-gradient(circle at 40% 80%, rgba(255,255,255,.06), transparent 45%),
        linear-gradient(#070a10, #05070b);
    }
    #scanlines{
      position: fixed; inset: 0; z-index: -1; pointer-events:none;
      background: repeating-linear-gradient(
        to bottom,
        rgba(255,255,255,.03) 0px,
        rgba(255,255,255,.03) 1px,
        rgba(0,0,0,0) 2px,
        rgba(0,0,0,0) 4px
      );
      mix-blend-mode: overlay;
      opacity:.25;
    }
    #nameScreen .wrap { height:100%; display:flex; align-items:center; justify-content:center; padding:18px; }
    #nameScreen .panel { width:min(520px, 92vw); }
    #nameScreen h1 { margin:0 0 6px 0; font-size: 26px; }
    #nameScreen .logo {
      font-weight: 1000; letter-spacing: 1px;
      font-size: 34px; margin-bottom: 10px;
      background: linear-gradient(90deg, #7bdff2, #ffd166, #ff3b3b);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    #lobbyMain { height:100%; box-sizing:border-box; padding:14px; display:grid; grid-template-columns: 360px 1fr 320px; gap:14px; min-height:0; }
    #roomsList { overflow:auto; max-height: calc(100vh - 190px); padding-right: 4px; }
    .roomRow {
      display:grid; grid-template-columns: 1fr auto; gap:10px;
      border:1px solid rgba(31,42,58,.9);
      border-radius:14px;
      padding:12px 12px;
      background: rgba(11,18,32,.55);
      margin-bottom:10px;
    }
    .roomTop { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .roomMeta { font-size:12px; color:#a8b3c7; margin-top:4px; }
    .roomBtns { display:flex; gap:8px; justify-content:flex-end; align-items:center; flex-wrap:wrap; }
    .pill {
      display:inline-flex; align-items:center; gap:6px;
      padding:3px 10px; border-radius: 999px;
      border:1px solid rgba(31,42,58,.85);
      background: rgba(0,0,0,.25);
      color:#a8b3c7; font-size:12px;
    }
    .dot { width:8px; height:8px; border-radius:50%; display:inline-block; background:#9fb0cc; }
    .dot.playing { background:#2bff88; }
    .dot.preparing { background:#ffd166; }
    .dot.finished { background:#ff3b3b; }

    #gameWrap { height:100%; display:flex; flex-direction:column; }
    #gameTopBar {
      padding:10px 12px; border-bottom:1px solid rgba(31,42,58,.85);
      display:flex; align-items:center; gap:10px;
      background: linear-gradient(180deg, rgba(10,14,22,.85), rgba(10,14,22,.55));
      backdrop-filter: blur(8px);
    }
    #gameTopBar .spacer { flex:1; }
    #canvasArea { flex: 1; min-height:0; display:flex; align-items:center; justify-content:center; background:#000; }
    #stage {
      position: relative;
      width: min(100vw, calc(100vh * 16 / 9));
      height: min(calc(100vw * 9 / 16), 100vh);
      background:#05070b;
      border: 1px solid rgba(31,42,58,.85);
      border-radius: 14px;
      overflow:hidden;
    }
    canvas { width:100%; height:100%; display:block; background:#05070b; }

    #hud {
      position:absolute; left:10px; top:10px;
      background: rgba(10,14,22,.70);
      border:1px solid rgba(31,42,58,.85);
      padding:10px 12px;
      border-radius:14px;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      color:#e8eefc;
      min-width: 280px;
      font-size: 13px;
      z-index: 10;
    }
    #hud .muted { font-size: 12px; }

    #ann { position:absolute; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.60); z-index: 20; }
    #ann .card { width:min(560px, 92vw); }

    #waveBanner {
      position:absolute; inset:0; display:none; align-items:center; justify-content:center;
      z-index: 30; pointer-events:none; background: rgba(0,0,0,.35);
    }
    #waveBanner .inner {
      padding: 18px 22px; border-radius: 18px; border: 1px solid rgba(31,42,58,.85);
      background: rgba(10,14,22,.72); backdrop-filter: blur(8px); text-align:center;
      min-width: min(520px, 90vw); box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    #waveBanner .title { font-weight: 1000; letter-spacing: .8px; font-size: 34px; margin-bottom: 6px; }
    #waveBanner .sub { color:#a8b3c7; font-size: 14px; }
  </style>
</head>
<body>
<div id="bg"></div>
<div id="scanlines"></div>

<div id="app">
  <header>
    <b>Invader Rooms</b>
    <small class="mono" id="me"></small>
    <span class="tag" id="adminTag" style="display:none;">ADMIN</span>
    <span class="tag" id="roomTag" style="display:none;">room:-</span>
    <div id="statusLine"></div>
  </header>

  <section id="nameScreen" class="screen active">
    <div class="wrap">
      <div class="panel card">
        <div class="logo">INVADER</div>
        <h1>名前を入力</h1>
        <p class="muted" style="margin:0 0 12px 0;">最初に1回だけ必要です（後で変更可）。</p>
        <input id="nameInput" placeholder="表示名（20文字まで）" maxlength="20" />
        <div class="row" style="margin-top:12px; justify-content:flex-end;">
          <button id="saveNameBtn">決定</button>
        </div>
        <div class="muted" id="nameHint" style="margin-top:10px;"></div>
      </div>
    </div>
  </section>

  <section id="lobbyScreen" class="screen">
    <div id="lobbyMain">
      <div class="col">
        <div class="card">
          <div style="font-weight:1000; font-size:18px; letter-spacing:.4px;">ロビー</div>
          <div class="muted" style="margin-top:8px; line-height:1.6;">
            操作：<b>A/D</b> 移動、<b>Space</b> 連射（CDなし）<br/>
            Wave：30/40/90/140秒（以降ボス継続・激化）<br/>
            ソロ専用
          </div>

          <div class="row" style="margin-top:12px;">
            <button id="createSoloBtn">ソロ部屋</button>
          </div>
          <div class="muted" id="createHint" style="margin-top:10px;"></div>

          <div class="row" style="margin-top:14px; justify-content:space-between;">
            <button id="changeNameBtn" class="ghost">名前を変更</button>
            <span class="muted" id="myNameLabel"></span>
          </div>
        </div>

        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div class="muted" style="font-weight:900;">運営</div>
            <div class="tag muted">pw 1122</div>
          </div>
          <div class="row" style="margin-top:10px;">
            <input id="adminPw" placeholder="1122" inputmode="numeric" maxlength="8" style="width:120px; padding:8px 10px; font-size:13px;" />
            <button id="adminEnterBtn" class="secondary small">決定</button>
            <button id="adminExitBtn" class="ghost small" style="display:none;">解除</button>
          </div>
          <div class="muted" style="margin-top:8px; font-size:12px;">
            運営はこの端末だけ（ローカル）で有効になります。
          </div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div style="font-weight:1000; font-size:18px;">部屋一覧</div>
            <span class="tag">最大5</span>
          </div>
          <div class="muted" style="margin-top:6px;">
            ソロ専用（マルチ機能は削除済み）
          </div>
          <div id="roomsList" style="margin-top:12px;"></div>
        </div>
      </div>

      <div class="col">
        <div class="card">
          <div class="row" style="justify-content:space-between;">
            <div class="muted" style="font-weight:1000;">ランキング（上位）</div>
            <span class="tag">Realtime</span>
          </div>
          <div id="leaderboard" style="margin-top:10px;"></div>
        </div>
      </div>
    </div>
  </section>

  <section id="gameScreen" class="screen">
    <div id="gameWrap">
      <div id="gameTopBar">
        <span class="tag" id="screenTitle">GAME</span>
        <span class="tag" id="youTag">YOU:-</span>
        <span class="tag" id="modeTag">mode:-</span>
        <span class="tag" id="stateTag">state:-</span>
        <div class="spacer"></div>
        <button id="readyBtn" class="secondary" style="display:none;">準備完了</button>
        <button id="retireBtn" class="danger" style="display:none;">リタイア（ホスト）</button>
        <button id="leaveRoomBtn" class="secondary">部屋を出る</button>
      </div>

      <div id="canvasArea">
        <div id="stage">
          <canvas id="game"></canvas>

          <div id="hud" style="display:none;">
            <div id="hudLine1"></div>
            <div id="hudLine2" style="margin-top:4px;"></div>
            <div id="hudLine3" class="muted" style="margin-top:6px;"></div>
          </div>

          <div id="waveBanner">
            <div class="inner">
              <div class="title" id="waveBannerTitle">WAVE 1/4</div>
              <div class="sub" id="waveBannerSub">5秒後に開始</div>
            </div>
          </div>

          <div id="ann">
            <div class="card">
              <div style="font-weight:1000; margin-bottom:6px;" id="annTitle"></div>
              <div class="muted" id="annBody"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-app.js";
  import { getDatabase, ref, onValue, get, set, update, remove, serverTimestamp, onDisconnect } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-database.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.8.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBePhUfYinZ02-1BWbZvzV3IBwoAYh-kxE",
    authDomain: "suisougaku-bdcc0.firebaseapp.com",
    databaseURL: "https://suisougaku-bdcc0-default-rtdb.firebaseio.com",
    projectId: "suisougaku-bdcc0",
    storageBucket: "suisougaku-bdcc0.firebasestorage.app",
    messagingSenderId: "636001978886",
    appId: "1:636001978886:web:24e68f1ef5b66dc7fa5187",
    measurementId: "G-Y04PFJ9BQ6"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);
  const auth = getAuth(app);

  const PATHS = {
    presence: (uid) => `presence/${uid}`,
    names: (uid) => `lobby/names/${uid}`,
    leaderboardTop: `leaderboard/top`,
    roomsIndex: `rooms_index`,
    room: (roomId) => `rooms/${roomId}`,
    roomIndex: (roomId) => `rooms_index/${roomId}`,
    roomGame: (roomId) => `rooms/${roomId}/game`,
    roomInputsRoot: (roomId) => `rooms/${roomId}/inputs`,
    roomInputs: (roomId, uid) => `rooms/${roomId}/inputs/${uid}`,
    roomReady: (roomId, uid) => `rooms/${roomId}/ready/${uid}`,
  };

  const $ = (q) => document.querySelector(q);
  const ui = {
    me: $("#me"),
    adminTag: $("#adminTag"),
    roomTag: $("#roomTag"),
    statusLine: $("#statusLine"),

    nameScreen: $("#nameScreen"),
    lobbyScreen: $("#lobbyScreen"),
    gameScreen: $("#gameScreen"),

    nameInput: $("#nameInput"),
    saveNameBtn: $("#saveNameBtn"),
    nameHint: $("#nameHint"),

    myNameLabel: $("#myNameLabel"),
    changeNameBtn: $("#changeNameBtn"),

    createSoloBtn: $("#createSoloBtn"),
    createHint: $("#createHint"),

    roomsList: $("#roomsList"),
    leaderboard: $("#leaderboard"),

    adminPw: $("#adminPw"),
    adminEnterBtn: $("#adminEnterBtn"),
    adminExitBtn: $("#adminExitBtn"),

    youTag: $("#youTag"),
    modeTag: $("#modeTag"),
    stateTag: $("#stateTag"),
    readyBtn: $("#readyBtn"),
    retireBtn: $("#retireBtn"),
    leaveRoomBtn: $("#leaveRoomBtn"),

    canvas: $("#game"),
    stage: $("#stage"),
    hud: $("#hud"),
    hudLine1: $("#hudLine1"),
    hudLine2: $("#hudLine2"),
    hudLine3: $("#hudLine3"),

    waveBanner: $("#waveBanner"),
    waveBannerTitle: $("#waveBannerTitle"),
    waveBannerSub: $("#waveBannerSub"),
  };

  function setScreen(name) {
    ui.nameScreen.classList.toggle("active", name === "name");
    ui.lobbyScreen.classList.toggle("active", name === "lobby");
    ui.gameScreen.classList.toggle("active", name === "game");
  }

  function uuidShort() { return Math.random().toString(16).slice(2, 10); }
  function escapeHtml(s) { return String(s).replace(/[&<>"']/g, (m) => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

  let adminMode = (localStorage.getItem("inv_admin") === "1");
  function setAdminMode(v) {
    adminMode = v;
    localStorage.setItem("inv_admin", v ? "1" : "0");
    ui.adminTag.style.display = v ? "" : "none";
    ui.adminExitBtn.style.display = v ? "" : "none";
  }
  setAdminMode(adminMode);
  ui.adminEnterBtn.onclick = () => {
    if (ui.adminPw.value.trim() === "1122") { setAdminMode(true); ui.adminPw.value = ""; }
    else alert("パスワードが違います");
  };
  ui.adminExitBtn.onclick = () => setAdminMode(false);

  async function bindPresence(userId) {
    const presRef = ref(db, PATHS.presence(userId));
    await set(presRef, { online: true, lastSeen: serverTimestamp() });
    onDisconnect(presRef).set({ online: false, lastSeen: serverTimestamp() });
  }
  async function isOnline(userId) {
    if (!userId) return false;
    const snap = await get(ref(db, PATHS.presence(userId)));
    return !!snap.val()?.online;
  }

  async function getMyName(userId) {
    const snap = await get(ref(db, PATHS.names(userId)));
    const v = snap.val();
    return (typeof v === "string" && v.trim()) ? v.trim() : "";
  }
  async function setMyName(userId, name) { await set(ref(db, PATHS.names(userId)), name); }

  function bindLeaderboard() {
    onValue(ref(db, PATHS.leaderboardTop), (snap) => {
      const data = snap.val() || [];
      ui.leaderboard.innerHTML = "";
      if (!Array.isArray(data) || data.length === 0) { ui.leaderboard.textContent = "まだ記録がありません"; return; }
      const ol = document.createElement("ol");
      ol.style.margin = "0 0 0 18px";
      for (const row of data) {
        const li = document.createElement("li");
        li.textContent = `${row.name ?? "?"} - ${row.score ?? 0}`;
        ol.appendChild(li);
      }
      ui.leaderboard.appendChild(ol);
    });
  }

  // ===== ここから下は、前回作った「ゲーム本体（createHostSim/描画/ホストロック）」をそのまま入れる必要があります =====
  // いま貼った修正版は「起動できない原因（createRoom重複）」を直した “骨組み” です。
  // あなたが欲しい機能（wave2強化/吸収装置/ボス強化/復活/即クリア）を全部入れたフル版は、
  // 直前に渡した “長い index.html” の createRoom重複だけを消したものになります。

  // なので確認：
  // 1) ブラウザのコンソール（F12）で出ているエラー全文を貼ってください（1行でもOK）
  // 2) もしくは、あなたが今使っている「最新の index.html 全文」をそのまま貼ってください
  //    → それを基に “動くフル版（全部入り）” を1つに統合して返します。
</script>
</body>
</html>
